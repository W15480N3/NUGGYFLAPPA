<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <title>HoppyNug - 702wish</title>
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.60.0/dist/phaser-arcade-physics.min.js"></script>
    <style>
        body { margin: 0; padding: 0; background-color: #000; overflow: hidden; display: flex; justify-content: center; align-items: center; height: 100vh; width: 100vw; font-family: 'Arial Black', sans-serif; }
        canvas { width: 100vw !important; height: 100vh !important; object-fit: contain; }
        #ui-layer { position: absolute; width: 100%; height: 100%; display: flex; justify-content: center; align-items: center; pointer-events: none; z-index: 100; }
        .menu { pointer-events: auto; background: rgba(0, 0, 0, 0.95); border: 2px solid #4ade80; border-radius: 15px; padding: 30px; color: white; text-align: center; }
        button { background: #4ade80; color: #000; border: none; padding: 12px 24px; font-size: 18px; font-weight: bold; border-radius: 5px; cursor: pointer; margin-top: 20px; }
        #mute-btn { position: absolute; top: 20px; right: 20px; pointer-events: auto; color: #666; font-size: 20px; cursor: pointer; z-index: 1000; }
    </style>
</head>
<body>

    <div id="mute-btn">ðŸ”Š</div>

    <div id="ui-layer">
        <div id="start-menu" class="menu">
            <h1 style="color: #4ade80; margin:0;">HoppyNug</h1>
            <div style="color: #fbbf24; letter-spacing: 2px; font-size: 12px; font-weight: bold;">702WISH</div>
            <p id="best-display" style="color: #888; margin: 10px 0;">RECORD: 0</p>
            <button id="start-btn">IGNITE</button>
        </div>

        <div id="game-over" class="menu" style="display: none;">
            <h1 style="color: #ff3333; margin:0;">WASTED</h1>
            <p id="final-score-text" style="font-size: 24px; margin: 10px 0;">SCORE: 0</p>
            <button id="retry-btn">RE-UP</button>
        </div>
    </div>

<script>
let isMuted = false, score = 0, isStarted = false, highScore = localStorage.getItem('hoppyNugBest') || 0;
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

document.getElementById('best-display').innerText = "RECORD: " + highScore;

const config = {
    type: Phaser.AUTO,
    width: 400, height: 600,
    backgroundColor: '#000000',
    physics: { default: 'arcade', arcade: { gravity: { y: 1200 }, debug: false } },
    scene: { preload: preload, create: create, update: update }
};

let game = new Phaser.Game(config);
let player, bongs, lighters, flames, smokeParticles, starGroup, scoreText;

function preload() {
    this.load.image('nug', 'nug.png'); 
    this.load.image('bong', 'bong.png'); 
    this.load.image('lighter', 'lighter.png'); 
    this.load.image('flame', 'flame.png'); 
    
    let g = this.make.graphics();
    g.fillStyle(0xffffff, 0.4); g.fillCircle(8, 8, 8);
    g.generateTexture('smoke_puff', 16, 16);
    
    let s = this.make.graphics();
    s.fillStyle(0xffffff, 1); s.fillCircle(2, 2, 2);
    s.generateTexture('pixel_star', 4, 4);
}

function create() {
    // Sporadic Stars
    starGroup = this.add.group();
    this.time.addEvent({
        delay: 400,
        callback: () => {
            let star = this.add.image(420, Phaser.Math.Between(0, 600), 'pixel_star');
            let colors = [0x4ade80, 0xbf80ff, 0x4da6ff, 0xfbbf24, 0xffffff];
            star.setTint(Phaser.Utils.Array.GetRandom(colors)).setAlpha(Phaser.Math.FloatBetween(0.1, 0.4));
            starGroup.add(star);
        },
        loop: true
    });

    // Particle Manager for Horizontal Smoke
    smokeParticles = this.add.particles(0, 0, 'smoke_puff', {
        scale: { start: 0.4, end: 1.8 },
        alpha: { start: 0.3, end: 0 },
        lifespan: 1000,
        speedX: { min: -100, max: -150 }, // Force it to move left behind the nug
        speedY: { min: -10, max: 10 },
        frequency: 50
    }).setDepth(5);

    player = this.physics.add.sprite(100, 300, 'nug').setScale(0.35);
    player.body.setCircle(55, 275, 85); // Adjusted circle hitbox
    player.body.allowGravity = false;

    scoreText = this.add.text(20, 20, '0', { fontSize: '42px', fill: '#4ade80', fontFamily: 'Arial Black' }).setAlpha(0.3).setDepth(100);

    bongs = this.physics.add.group();
    lighters = this.physics.add.group();
    flames = this.physics.add.group();

    this.input.on('pointerdown', () => {
        if (!isStarted) return;
        player.setVelocityY(-420);
    });

    // Overlap checks for fair deaths
    this.physics.add.overlap(player, bongs, gameOver, null, this);
    this.physics.add.overlap(player, lighters, gameOver, null, this);
    this.physics.add.overlap(player, flames, gameOver, null, this);

    document.getElementById('start-btn').onclick = () => startGame.call(this);
    document.getElementById('retry-btn').onclick = () => window.location.reload();
}

function update() {
    starGroup.getChildren().forEach(s => { s.x -= 0.5; if (s.x < -20) s.destroy(); });

    if (!isStarted) {
        player.y = 300 + Math.sin(this.time.now / 400) * 10;
        return;
    }

    // Horizontal Smoke Trail
    smokeParticles.emitParticleAt(player.x - 25, player.y);

    if (player.y > 600 || player.y < 0) gameOver.call(this);

    bongs.getChildren().forEach(bong => {
        if (bong.x < player.x && !bong.scored) {
            score += 0.5;
            if(Math.floor(score) > Math.floor(score - 0.5)) scoreText.setText(Math.floor(score));
            bong.scored = true;
        }
        if (bong.x < -100) bong.destroy();
    });

    lighters.getChildren().forEach((l, i) => {
        let f = flames.getChildren()[i];
        l.y = l.startY + Math.sin(this.time.now / 300) * 40;
        if (f) { f.x = l.x - 20; f.y = l.y; }
        if (l.x < -100) { l.destroy(); if (f) f.destroy(); }
    });
}

function spawnLighter() {
    if (!isStarted) return;
    let y = Phaser.Math.Between(150, 450);
    let l = lighters.create(500, y, 'lighter').setScale(0.08);
    l.body.allowGravity = false;
    l.setVelocityX(-200);
    l.startY = y;
    l.body.setCircle(20).setOffset(l.width*0.35, l.height*0.35);

    let f = flames.create(l.x - 20, y, 'flame').setScale(0.08);
    f.body.allowGravity = false;
    f.setVelocityX(-200);
    f.body.setSize(10,10);
}

function spawnBongs() {
    if (!isStarted) return;
    const y = Phaser.Math.Between(150, 450);
    const top = bongs.create(550, y - 145, 'bong').setOrigin(0.5, 1).setFlipY(true);
    const bot = bongs.create(550, y + 145, 'bong').setOrigin(0.5, 0);
    top.body.allowGravity = false; bot.body.allowGravity = false;
    top.setVelocityX(-220); bot.setVelocityX(-220);
    top.body.setSize(50, 380).setOffset(330, 0);
    bot.body.setSize(50, 380).setOffset(330, 0);

    // BONG SMOKE
    this.time.addEvent({
        delay: 100, repeat: 15,
        callback: () => {
            if (bot.active) {
                smokeParticles.emitParticleAt(bot.x, bot.y + 5);
                smokeParticles.emitParticleAt(top.x, top.y - 5);
            }
        }
    });
}

function startGame() {
    isStarted = true;
    player.body.allowGravity = true;
    document.getElementById('start-menu').style.display = 'none';
    this.time.addEvent({ delay: 2000, callback: spawnBongs, callbackScope: this, loop: true });
    this.time.addEvent({ delay: 5000, callback: spawnLighter, callbackScope: this, loop: true });
}

function gameOver() {
    if (!isStarted) return;
    isStarted = false;
    this.physics.pause();
    player.setTint(0xff3333);
    let final = Math.floor(score);
    if (final > highScore) localStorage.setItem('hoppyNugBest', final);
    document.getElementById('game-over').style.display = 'block';
    document.getElementById('final-score-text').innerText = "SCORE: " + final;
}
</script>
</body>
</html>

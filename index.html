<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <title>High Flyer Promo</title>
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.60.0/dist/phaser-arcade-physics.min.js"></script>
    <style>
        body { 
            margin: 0; padding: 0; background-color: #0a1a0a; 
            overflow: hidden; display: flex; justify-content: center; 
            align-items: center; height: 100vh; font-family: sans-serif; 
        }
        /* The UI Layer sits on top of the game */
        #ui-layer { 
            position: absolute; width: 400px; height: 600px;
            display: flex; justify-content: center; align-items: center;
            pointer-events: none; /* Allows clicks to pass through to game by default */
            z-index: 10;
        }
        .menu { 
            pointer-events: auto; /* Buttons inside menus ARE clickable */
            background: rgba(10, 30, 10, 0.95); 
            border: 3px solid #4ade80; border-radius: 20px; 
            padding: 30px; color: white; text-align: center;
            box-shadow: 0 0 20px rgba(74, 222, 128, 0.5);
        }
        h1 { color: #4ade80; margin-top: 0; font-size: 28px; letter-spacing: 2px; }
        button { 
            background: #4ade80; color: #000; border: none; 
            padding: 15px 30px; font-size: 18px; font-weight: bold; 
            border-radius: 10px; cursor: pointer; margin-top: 10px;
        }
        .coupon-box { font-size: 24px; color: #fbbf24; margin: 15px 0; font-weight: bold; }
    </style>
</head>
<body>

    <div id="ui-layer">
        <div id="start-menu" class="menu">
            <h1>HIGH FLYER</h1>
            <p>Tap to levitate through the smoke.</p>
            <button id="start-btn">START BLAZING</button>
        </div>

        <div id="game-over" class="menu" style="display: none;">
            <h1>BUSTED!</h1>
            <p id="final-score">Score: 0</p>
            <div id="coupon-area" class="coupon-box" style="display: none;">CODE: BLAZE20</div>
            <p id="fail-msg">Get 10 points for a discount!</p>
            <button id="retry-btn">RETRY</button>
        </div>
    </div>

<script>
const config = {
    type: Phaser.AUTO,
    width: 400,
    height: 600,
    backgroundColor: '#0a1a0a',
    physics: { 
        default: 'arcade', 
        arcade: { gravity: { y: 1200 }, debug: false } 
    },
    scene: { preload: preload, create: create, update: update }
};

let game = new Phaser.Game(config);
let player, bongs, score = 0, isStarted = false, smokeParticles, spawnTimer;

function preload() {
    // Load your nug image - make sure the filename matches exactly!
    this.load.image('nug', 'nug.png'); 

    // Create procedural assets
    let gfx = this.make.graphics();
    
    // Smoke Particle
    gfx.fillStyle(0xffffff, 0.2);
    gfx.fillCircle(10, 10, 10);
    gfx.generateTexture('smoke', 20, 20);

    // Bong Obstacle
    gfx.clear();
    gfx.lineStyle(4, 0x4ade80, 1);
    gfx.fillStyle(0x818cf8, 0.5);
    gfx.fillRect(0, 0, 60, 500);
    gfx.strokeRect(0, 0, 60, 500);
    gfx.generateTexture('bong', 60, 500);
}

function create() {
    // Player Setup
    player = this.physics.add.sprite(100, 300, 'nug');
    player.setScale(0.4); 
    player.setCircle(100, 50, 50); // Adjusted for the levitating posture
    player.body.allowGravity = false; // Stay still until start

    // Smoke System
    smokeParticles = this.add.particles(0, 0, 'smoke', {
        scale: { start: 1, end: 4 },
        alpha: { start: 0.4, end: 0 },
        lifespan: 1500,
        speed: { min: 20, max: 40 },
        frequency: 100
    });

    bongs = this.physics.add.group();

    // Input Handling
    this.input.on('pointerdown', () => {
        if (!isStarted) return;
        player.setVelocityY(-420); // The "Flap"
        this.tweens.add({ targets: player, angle: -15, duration: 100, yoyo: true });
    });

    this.physics.add.collider(player, bongs, gameOver, null, this);

    // Link HTML Buttons
    document.getElementById('start-btn').onclick = () => startGame.call(this);
    document.getElementById('retry-btn').onclick = () => window.location.reload();
}

function update() {
    if (!isStarted) {
        // Gentle idle hover before game starts
        player.y = 300 + Math.sin(this.time.now / 300) * 10;
        return;
    }

    // Check for out of bounds
    if (player.y > 600 || player.y < 0) {
        gameOver.call(this);
    }

    // Clean up bongs that passed the player and increment score
    bongs.children.entries.forEach(bong => {
        if (bong.x < -60) {
            if (!bong.scored) {
                score += 0.5; // Two bongs per set = 1 point total
                bong.scored = true;
            }
            bong.destroy();
        }
    });
}

function spawnBongs() {
    if (!isStarted) return;

    const gap = 190; // The vertical space to fly through
    const randomY = Phaser.Math.Between(150, 450);

    const topBong = bongs.create(450, randomY - (gap / 2), 'bong').setOrigin(0.5, 1);
    const botBong = bongs.create(450, randomY + (gap / 2), 'bong').setOrigin(0.5, 0);

    topBong.body.allowGravity = false;
    botBong.body.allowGravity = false;
    topBong.setVelocityX(-220);
    botBong.setVelocityX(-220);

    // Emit smoke from the top of the bottom bong
    smokeParticles.emitParticleAt(450, randomY + (gap / 2));
}

function startGame() {
    document.getElementById('start-menu').style.display = 'none';
    isStarted = true;
    player.body.allowGravity = true;
    
    // Start Spawning every 1.6 seconds
    spawnTimer = this.time.addEvent({ 
        delay: 1600, 
        callback: spawnBongs, 
        callbackScope: this, 
        loop: true 
    });
}

function gameOver() {
    if (!isStarted) return;
    isStarted = false;
    
    this.physics.pause();
    if (spawnTimer) spawnTimer.remove();
    player.setTint(0xff3333);
    
    // UI Updates
    document.getElementById('game-over').style.display = 'block';
    document.getElementById('final-score').innerText = "SCORE: " + Math.floor(score);
    
    if (score >= 10) {
        document.getElementById('coupon-area').style.display = 'block';
        document.getElementById('fail-msg').innerText = "STASH UNLOCKED!";
    }
}
</script>
</body>
</html>

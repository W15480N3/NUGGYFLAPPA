<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <title>HoppyNug - 702wish</title>
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.60.0/dist/phaser-arcade-physics.min.js"></script>
    <style>
        body { margin: 0; padding: 0; background-color: #000; overflow: hidden; display: flex; justify-content: center; align-items: center; height: 100vh; width: 100vw; font-family: 'Arial Black', sans-serif; }
        canvas { width: 100vw !important; height: 100vh !important; object-fit: contain; }
        #ui-layer { position: absolute; width: 100%; height: 100%; display: flex; justify-content: center; align-items: center; pointer-events: none; z-index: 100; }
        .menu { pointer-events: auto; background: rgba(10, 30, 10, 0.95); border: 3px solid #fbbf24; border-radius: 20px; padding: 30px; color: white; text-align: center; box-shadow: 0 0 30px #fbbf24; }
        h1 { color: #4ade80; margin: 0; font-size: 42px; text-shadow: 0 0 15px #4ade80; }
        .creator-tag { font-size: 14px; color: #fbbf24; margin-top: 5px; letter-spacing: 2px; font-weight: bold; }
        button { background: #fbbf24; color: #000; border: none; padding: 15px 30px; font-size: 20px; font-weight: bold; border-radius: 10px; cursor: pointer; margin-top: 20px; transition: 0.2s; }
        button:hover { transform: scale(1.1); background: #4ade80; }
        #mute-btn { position: absolute; top: 20px; right: 20px; pointer-events: auto; background: rgba(0,0,0,0.6); color: white; border: 2px solid white; padding: 10px; border-radius: 50%; width: 50px; height: 50px; font-size: 20px; display: flex; align-items: center; justify-content: center; cursor: pointer; }
    </style>
</head>
<body>

    <div id="mute-btn">ðŸ”Š</div>

    <div id="ui-layer">
        <div id="start-menu" class="menu">
            <h1>HoppyNug</h1>
            <div class="creator-tag">702WISH ORIGINALS</div>
            <p>VIVA LAS VEGAS</p>
            <div style="margin: 10px 0;">RECORD: <span id="best-score-start">0</span></div>
            <button id="start-btn">START BLAZING</button>
        </div>

        <div id="game-over" class="menu" style="display: none;">
            <h1>BUSTED!</h1>
            <div class="creator-tag">BY 702WISH</div>
            <div style="margin: 10px 0;">SCORE: <span id="final-score">0</span></div>
            <div style="color: #4ade80;">BEST: <span id="best-score-over">0</span></div>
            <button id="retry-btn">TRY AGAIN</button>
        </div>
    </div>

<script>
let isMuted = false;
let jackpotPlayed = false;
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
const muteBtn = document.getElementById('mute-btn');

muteBtn.onclick = () => {
    isMuted = !isMuted;
    muteBtn.innerText = isMuted ? 'ðŸ”‡' : 'ðŸ”Š';
};

function playSound(type) {
    if (isMuted) return;
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    osc.connect(gain); gain.connect(audioCtx.destination);
    const now = audioCtx.currentTime;

    if (type === 'flap') {
        osc.type = 'triangle'; osc.frequency.setValueAtTime(150, now);
        osc.frequency.exponentialRampToValueAtTime(400, now + 0.1);
        gain.gain.setValueAtTime(0.05, now); gain.gain.exponentialRampToValueAtTime(0.01, now + 0.1);
        osc.start(); osc.stop(now + 0.1);
    } else if (type === 'jackpot') {
        osc.type = 'sine'; 
        osc.frequency.setValueAtTime(523.25, now);
        osc.frequency.setValueAtTime(659.25, now + 0.1);
        osc.frequency.setValueAtTime(783.99, now + 0.2);
        gain.gain.setValueAtTime(0.1, now); gain.gain.exponentialRampToValueAtTime(0.01, now + 0.4);
        osc.start(); osc.stop(now + 0.4);
    } else if (type === 'crash') {
        const buffer = audioCtx.createBuffer(1, audioCtx.sampleRate * 0.3, audioCtx.sampleRate);
        const data = buffer.getChannelData(0);
        for (let i = 0; i < data.length; i++) data[i] = Math.random() * 2 - 1;
        const noise = audioCtx.createBufferSource(); noise.buffer = buffer;
        const nGain = audioCtx.createGain(); noise.connect(nGain); nGain.connect(audioCtx.destination);
        nGain.gain.setValueAtTime(0.1, now); nGain.gain.exponentialRampToValueAtTime(0.01, now + 0.3);
        noise.start();
    }
}

const config = {
    type: Phaser.AUTO,
    width: 400, height: 600,
    pixelArt: true,
    physics: { 
        default: 'arcade', 
        arcade: { gravity: { y: 1300 }, debug: false } // DEBUG OFF
    }, 
    scene: { preload: preload, create: create, update: update }
};

let game = new Phaser.Game(config);
let player, bongs, lighters, flames, background, score = 0, isStarted = false, lighterTimer, scoreText, smokeParticles;

let highScore = localStorage.getItem('hoppyNugBest') || 0;
document.getElementById('best-score-start').innerText = highScore;

function preload() {
    this.load.image('nug', 'nug.png'); 
    this.load.image('bong', 'bong.png'); 
    this.load.image('vegas', 'vegas.png?v=' + Date.now()); 
    this.load.image('lighter', 'lighter.png'); 
    this.load.image('flame', 'flame.png'); 
    
    let gfx = this.make.graphics();
    gfx.fillStyle(0xffffff, 0.4); gfx.fillCircle(10, 10, 10);
    gfx.generateTexture('smoke', 20, 20);
}

function create() {
    background = this.add.tileSprite(0, 0, 400, 600, 'vegas').setOrigin(0, 0);
    let scaleFactor = 600 / background.height;
    background.tileScaleY = scaleFactor;
    background.tileScaleX = scaleFactor;

    smokeParticles = this.add.particles(0, 0, 'smoke', {
        scale: { start: 0.5, end: 2 },
        alpha: { start: 0.6, end: 0 },
        lifespan: 800,
        speed: { min: 20, max: 40 },
        angle: { min: 160, max: 200 },
        frequency: 50
    }).setDepth(5); 

    player = this.physics.add.sprite(100, 300, 'nug');
    player.setScale(0.35);
    player.body.setSize(130, 130).setOffset(265, 75); 
    player.body.allowGravity = false;
    player.setDepth(20);

    scoreText = this.add.text(20, 20, 'Score: 0', { 
        fontSize: '32px', fill: '#4ade80', fontFamily: 'Arial Black', stroke: '#000', strokeThickness: 5 
    }).setDepth(100);

    bongs = this.physics.add.group();
    lighters = this.physics.add.group();
    flames = this.physics.add.group();

    this.input.on('pointerdown', () => {
        if (!isStarted) return;
        if (audioCtx.state === 'suspended') audioCtx.resume();
        player.setVelocityY(-450);
        playSound('flap');
    });

    this.physics.add.collider(player, bongs, gameOver, null, this);
    this.physics.add.collider(player, flames, gameOver, null, this);
    this.physics.add.collider(player, lighters, gameOver, null, this);

    document.getElementById('start-btn').onclick = () => startGame.call(this);
    document.getElementById('retry-btn').onclick = () => window.location.reload();
}

function update() {
    background.tilePositionX += 2; 

    if (!isStarted) {
        player.y = 300 + Math.sin(this.time.now / 300) * 15;
        return;
    }

    smokeParticles.emitParticleAt(player.x - 20, player.y);

    if (player.y > 600 || player.y < 0) gameOver.call(this);
    
    if (Math.floor(score) > highScore && !jackpotPlayed && highScore > 0) {
        playSound('jackpot');
        jackpotPlayed = true;
        scoreText.setFill('#fbbf24');
    }

    lighters.getChildren().forEach((lighter, index) => {
        let flame = flames.getChildren()[index];
        lighter.y = lighter.startY + Math.sin(this.time.now / 200) * 60;
        if (flame) {
            flame.x = lighter.x - (lighter.displayWidth * 0.45); 
            flame.y = lighter.y;
        }
        if (lighter.x < -150) {
            lighter.destroy();
            if (flame) flame.destroy();
        }
    });

    bongs.getChildren().forEach(bong => {
        if (bong.x < player.x && !bong.scored) {
            score += 0.5;
            if(Math.floor(score) > Math.floor(score - 0.5)) {
                scoreText.setText('Score: ' + Math.floor(score));
            }
            bong.scored = true;
        }
        if (bong.x < -150) bong.destroy();
    });
}

function spawnLighter() {
    if (!isStarted) return;
    let randomY = Phaser.Math.Between(150, 450);
    let speed = Phaser.Math.Between(-350, -500);

    let lighter = lighters.create(550, randomY, 'lighter');
    lighter.body.allowGravity = false;
    lighter.setVelocityX(speed);
    lighter.setScale(0.07); 
    lighter.body.setCircle(lighter.width * 0.15); 
    lighter.body.setOffset(lighter.width * 0.35, lighter.height * 0.35);
    lighter.startY = randomY;

    let flame = flames.create(lighter.x - 30, randomY, 'flame');
    flame.body.allowGravity = false;
    flame.setVelocityX(speed);
    flame.setScale(0.07);
    flame.body.setSize(flame.width * 0.1, flame.height * 0.1);
    flame.body.setOffset(flame.width * 0.45, flame.height * 0.45);

    this.tweens.add({ targets: flame, alpha: 0.3, duration: 50, yoyo: true, repeat: -1 });
}

function spawnBongs() {
    if (!isStarted) return;
    const gap = 280; 
    const randomY = Phaser.Math.Between(150, 450);
    const topBong = bongs.create(600, randomY - (gap / 2), 'bong').setOrigin(0.5, 1).setFlipY(true);
    const botBong = bongs.create(600, randomY + (gap / 2), 'bong').setOrigin(0.5, 0);
    
    topBong.body.allowGravity = false;
    botBong.body.allowGravity = false;
    topBong.setVelocityX(-240);
    botBong.setVelocityX(-240);
    topBong.setDepth(8);
    botBong.setDepth(8);

    topBong.body.setSize(40, 300).setOffset(335, 0); 
    botBong.body.setSize(40, 300).setOffset(335, 0); 

    this.time.addEvent({
        delay: 50, repeat: 30, 
        callback: () => {
            if (botBong.active) {
                smokeParticles.emitParticleAt(botBong.x, botBong.y + 10);
                smokeParticles.emitParticleAt(topBong.x, topBong.y - 10);
            }
        }
    });
}

function startGame() {
    if (audioCtx.state === 'suspended') audioCtx.resume();
    document.getElementById('start-menu').style.display = 'none';
    isStarted = true;
    player.body.allowGravity = true;
    this.time.addEvent({ delay: 1800, callback: spawnBongs, callbackScope: this, loop: true });
    lighterTimer = this.time.addEvent({ 
        delay: Phaser.Math.Between(3000, 6000), 
        callback: () => { spawnLighter.call(this); lighterTimer.delay = Phaser.Math.Between(3000, 6000); }, 
        callbackScope: this, loop: true 
    });
}

function gameOver() {
    if (!isStarted) return;
    isStarted = false;
    playSound('crash');
    this.physics.pause();
    player.setTint(0xff3333);
    let finalScore = Math.floor(score);
    if (finalScore > highScore) {
        highScore = finalScore;
        localStorage.setItem('hoppyNugBest', highScore);
    }
    document.getElementById('game-over').style.display = 'block';
    document.getElementById('final-score').innerText = finalScore;
    document.getElementById('best-score-over').innerText = highScore;
}
</script>
</body>
</html>

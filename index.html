<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <title>HoppyNug - 702wish</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;900&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.60.0/dist/phaser-arcade-physics.min.js"></script>
    <style>
        body { margin: 0; padding: 0; background-color: #000; overflow: hidden; display: flex; justify-content: center; align-items: center; height: 100vh; width: 100vw; font-family: 'Orbitron', sans-serif; }
        canvas { width: 100vw !important; height: 100vh !important; object-fit: contain; }
        #ui-layer { position: absolute; width: 100%; height: 100%; display: flex; justify-content: center; align-items: center; pointer-events: none; z-index: 100; }
        .menu { pointer-events: auto; background: rgba(0, 15, 5, 0.95); border: 3px solid #4ade80; border-radius: 20px; padding: 40px; color: white; text-align: center; box-shadow: 0 0 30px rgba(74, 222, 128, 0.4); text-transform: uppercase; }
        input#player-name { background: #000; border: 2px solid #4ade80; color: #4ade80; padding: 12px; font-size: 20px; border-radius: 8px; text-align: center; margin: 20px 0; width: 85%; outline: none; font-family: 'Orbitron', sans-serif; }
        button { background: #4ade80; color: #000; border: none; padding: 15px; font-size: 22px; font-weight: 900; border-radius: 8px; cursor: pointer; width: 100%; font-family: 'Orbitron', sans-serif; }
        #mute-btn { position: absolute; top: 20px; right: 20px; pointer-events: auto; color: #4ade80; font-size: 24px; cursor: pointer; z-index: 1000; background: rgba(0,0,0,0.6); padding: 10px; border-radius: 12px; border: 1px solid #4ade80; width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; user-select: none; }
    </style>
</head>
<body>
    <div id="mute-btn">ðŸ”Š</div>
    <div id="ui-layer">
        <div id="start-menu" class="menu">
            <h1 style="color: #4ade80; margin:0; font-size: 46px; font-weight: 900;">HOPPYNUG</h1>
            <input type="text" id="player-name" placeholder="ID TAG" maxlength="10">
            <p id="best-display" style="color: #666; margin: 10px 0; font-size: 14px;">PERSONAL BEST: 0</p>
            <button id="start-btn">LIGHT UP</button>
        </div>
        <div id="game-over" class="menu" style="display: none;">
            <h1 style="color: #ff3333; margin:0; font-size: 40px;">CASHED OUT!</h1>
            <p id="final-score-text" style="font-size: 28px; margin: 20px 0; color: #4ade80;">SCORE: 0</p>
            <button id="retry-btn">RE-UP</button>
        </div>
    </div>

<script>
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
let isMuted = false, score = 0, isStarted = false;
let playerName = localStorage.getItem('hoppyNugName') || "";
let highScore = parseInt(localStorage.getItem('hoppyNugBest')) || 0;

document.getElementById('mute-btn').onclick = function() {
    isMuted = !isMuted;
    this.innerText = isMuted ? "ðŸ”‡" : "ðŸ”Š";
};

function playSfx(type) {
    if (isMuted) return;
    if (audioCtx.state === 'suspended') audioCtx.resume();
    const osc = audioCtx.createOscillator(), gain = audioCtx.createGain();
    osc.connect(gain); gain.connect(audioCtx.destination);
    const now = audioCtx.currentTime;
    if (type === 'jump') { osc.type = 'triangle'; osc.frequency.setValueAtTime(180, now); osc.frequency.exponentialRampToValueAtTime(30, now + 0.15); gain.gain.setValueAtTime(0.4, now); gain.gain.linearRampToValueAtTime(0, now + 0.15); osc.start(); osc.stop(now + 0.15); }
    else if (type === 'point') { osc.type = 'sine'; osc.frequency.setValueAtTime(600, now); osc.frequency.exponentialRampToValueAtTime(900, now + 0.1); gain.gain.setValueAtTime(0.08, now); gain.gain.linearRampToValueAtTime(0, now + 0.2); osc.start(); osc.stop(now + 0.2); }
    else if (type === 'crash') { osc.type = 'sawtooth'; osc.frequency.setValueAtTime(100, now); osc.frequency.linearRampToValueAtTime(20, now + 0.4); gain.gain.setValueAtTime(0.2, now); gain.gain.linearRampToValueAtTime(0, now + 0.4); osc.start(); osc.stop(now + 0.4); }
}

const nameInput = document.getElementById('player-name');
nameInput.value = playerName;
document.getElementById('best-display').innerText = "PERSONAL BEST: " + highScore;

const config = { 
    type: Phaser.AUTO, width: 400, height: 600, backgroundColor: '#000000', 
    physics: { default: 'arcade', arcade: { gravity: { y: 1200 }, debug: false } }, 
    scene: { preload, create, update } 
};

let game = new Phaser.Game(config);
let player, bongs, lighters, flames, smokeParticlesUp, smokeParticlesDown, starGroup, scoreText, scoreBox;

function preload() {
    this.load.image('nug', 'nug.png'); this.load.image('nug_active', 'nug_active.png'); 
    this.load.image('bong', 'bong.png'); this.load.image('lighter', 'lighter.png'); 
    this.load.image('flame', 'flame.png');
    let g = this.make.graphics(); g.fillStyle(0xffffff, 1); g.fillCircle(8, 8, 8); g.generateTexture('smoke_puff', 16, 16);
    let s = this.make.graphics(); s.fillStyle(0xffffff, 1); s.fillCircle(2, 2, 2); s.generateTexture('pixel_star', 4, 4);
}

function create() {
    starGroup = this.add.group();
    this.time.addEvent({ delay: 450, callback: () => { let star = this.add.image(420, Phaser.Math.Between(0, 600), 'pixel_star'); star.setAlpha(Phaser.Math.FloatBetween(0.1, 0.3)); starGroup.add(star); }, loop: true });
    
    // TWO EMITTERS: One for shooting up, one for shooting down
    smokeParticlesUp = this.add.particles(0, 0, 'smoke_puff', { scale: { start: 0.4, end: 1.6 }, alpha: { start: 0.7, end: 0 }, lifespan: 1000, speedY: { min: -250, max: -450 }, speedX: { min: -20, max: 20 }, frequency: -1 }).setDepth(5);
    smokeParticlesDown = this.add.particles(0, 0, 'smoke_puff', { scale: { start: 0.4, end: 1.6 }, alpha: { start: 0.7, end: 0 }, lifespan: 1000, speedY: { min: 250, max: 450 }, speedX: { min: -20, max: 20 }, frequency: -1 }).setDepth(5);
    
    player = this.physics.add.sprite(100, 300, 'nug').setScale(0.35).setDepth(10);
    player.body.setCircle(45, 290, 95); player.body.allowGravity = false;

    scoreBox = this.add.graphics().setDepth(99);
    scoreText = this.add.text(30, 30, '', { fontSize: '18px', fill: '#4ade80', fontFamily: 'Orbitron', fontWeight: '900' }).setDepth(100);
    
    bongs = this.physics.add.group(); lighters = this.physics.add.group(); flames = this.add.group();
    
    this.input.on('pointerdown', () => { if (!isStarted) return; player.setVelocityY(-410); playSfx('jump'); player.setTexture('nug_active'); this.time.delayedCall(150, () => { if (isStarted) player.setTexture('nug'); }); triggerGlitch(); });
    this.physics.add.overlap(player, bongs, gameOver, null, this);
    this.physics.add.overlap(player, lighters, gameOver, null, this);
    
    document.getElementById('start-btn').onclick = () => startGame.call(this);
    document.getElementById('retry-btn').onclick = () => window.location.reload();
}

function drawScoreBox(xOffset = 0, yOffset = 0) {
    scoreBox.clear(); scoreBox.lineStyle(2, 0x4ade80, 0.8);
    scoreBox.strokeRect(20 + xOffset, 20 + yOffset, scoreText.width + 20, scoreText.height + 20);
}

function triggerGlitch() { if (!isStarted) return; scoreText.setX(20 + Phaser.Math.Between(-4, 4)); }

function update() {
    starGroup.getChildren().forEach(s => { s.x -= 0.6; if (s.x < -20) s.destroy(); });
    if (!isStarted) { player.y = 300 + Math.sin(this.time.now / 400) * 10; return; }
    scoreText.setX(Phaser.Math.Linear(scoreText.x, 30, 0.15));
    drawScoreBox(scoreText.x - 30, scoreText.y - 30);
    
    // Nug Smoke (Drifts back)
    if (this.time.now % 60 < 20) smokeParticlesUp.emitParticleAt(player.x - 25, player.y + 5);
    if (player.y > 600 || player.y < 0) gameOver.call(this);
    
    bongs.getChildren().forEach(bong => {
        // Vertical Smoke from Mouthpieces
        if (bong.x > 0 && bong.x < 420 && this.time.now % 100 < 30) {
            if (bong.flipY) {
                // Top Bong: Shoot DOWN
                smokeParticlesDown.emitParticleAt(bong.x, bong.y + 10);
            } else {
                // Bottom Bong: Shoot UP
                smokeParticlesUp.emitParticleAt(bong.x, bong.y - 10);
            }
        }
        if (bong.x < player.x && !bong.scored) { score += 0.5; if(Math.floor(score) > Math.floor(score - 0.5)) { scoreText.setText(`${playerName.toUpperCase()}: ${Math.floor(score)}`); playSfx('point'); } bong.scored = true; }
        if (bong.x < -100) bong.destroy();
    });

    lighters.getChildren().forEach((l, i) => { 
        let f = flames.getChildren()[i]; 
        l.angle += 3.5;
        l.y = l.startY + Math.sin(this.time.now / 300) * 40; 
        if (f) { 
            let rad = Phaser.Math.DegToRad(l.angle + 180);
            f.x = l.x + Math.cos(rad) * 45; f.y = l.y + Math.sin(rad) * 45; f.angle = l.angle;
        } 
        if (l.x < -100) { l.destroy(); if (f) f.destroy(); } 
    });
}

function spawnLighter() {
    if (!isStarted) return;
    let y = Phaser.Math.Between(150, 450);
    let l = lighters.create(500, y, 'lighter').setScale(0.08).setDepth(8);
    l.body.allowGravity = false; l.setVelocityX(-180); l.startY = y;
    l.body.setCircle(180).setOffset(90, 90); 
    let f = flames.create(l.x - 45, y, 'flame').setScale(0.08).setDepth(9);
    this.tweens.add({ targets: f, alpha: 0.2, duration: 50, yoyo: true, repeat: -1 }); 
}

function spawnBongs() {
    if (!isStarted) return;
    const y = Phaser.Math.Between(150, 450);
    const gapSize = 140; 
    const top = bongs.create(550, y - gapSize, 'bong').setOrigin(0.5, 1).setFlipY(true);
    const bot = bongs.create(550, y + gapSize, 'bong').setOrigin(0.5, 0);
    top.body.allowGravity = false; bot.body.allowGravity = false;
    top.setVelocityX(-210); bot.setVelocityX(-210);
    top.body.setSize(80, 380).setOffset(320, 0); 
    bot.body.setSize(80, 380).setOffset(320, 0);
}

function startGame() { 
    playerName = nameInput.value || "PILOT"; 
    localStorage.setItem('hoppyNugName', playerName);
    scoreText.setText(`${playerName.toUpperCase()}: 0`); 
    drawScoreBox(); isStarted = true; player.body.allowGravity = true; 
    document.getElementById('start-menu').style.display = 'none'; 
    this.time.addEvent({ delay: 2200, callback: spawnBongs, callbackScope: this, loop: true }); 
    this.time.addEvent({ delay: 5000, callback: spawnLighter, callbackScope: this, loop: true }); 
}

function gameOver() { 
    if (!isStarted) return; 
    isStarted = false; playSfx('crash'); this.physics.pause(); 
    player.setTint(0xff3333); player.setTexture('nug'); 
    let final = Math.floor(score);
    if (final > highScore) localStorage.setItem('hoppyNugBest', final);
    document.getElementById('game-over').style.display = 'block'; 
    document.getElementById('final-score-text').innerText = "SCORE: " + final; 
}
</script>
</body>
</html>
